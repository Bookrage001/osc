var browserify = require('browserify'),
    exorcist = require('exorcist'),
    licensify = require('licensify'),
    fs = require('fs'),
    path = require('path')


module.exports = (opt) => {

    var {input, output, options, ignore, exclude, transforms, plugins} = opt,
        inputPath = path.resolve(__dirname + '/' + input),
        outputPath = path.resolve(__dirname + '/' + output),
        b

    if (!plugins) plugins = []
    if (!plugins.includes(licensify)) plugins.push(licensify)

    b = browserify(inputPath, options)

    if (ignore) b.ignore(ignore)
    if (exclude) b.exclude(exclude)

    for (var plugin of plugins) {
        b.plugin(plugin)
    }

    if (transforms) {
        for (var transform of transforms) {
            var [t, opts] = transform
            b.transform(t, opts)
        }
    }

    function bundle() {

        var output =  b.bundle()

        output.pipe(exorcist(outputPath + '.map'))
        output.pipe(fs.createWriteStream(outputPath))

        return output

    }

    bundle.b = b

    return bundle

}
